<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Dashboard - OTMS</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
    }

    /* Top Navigation Bar */
    .top-nav {
      background: #1e293b;
      padding: 0 40px;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #334155;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .nav-left {
      display: flex;
      align-items: center;
      gap: 30px;
    }

    .logo {
      font-size: 24px;
      font-weight: 700;
      color: white;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo-icon {
      width: 36px;
      height: 36px;
      background: #15803d;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      font-weight: 700;
    }

    .nav-links {
      display: flex;
      gap: 5px;
    }

    .nav-link {
      padding: 8px 16px;
      color: #94a3b8;
      text-decoration: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .nav-link:hover {
      background: #334155;
      color: white;
    }

    .nav-link.active {
      background: #334155;
      color: white;
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    /* Add Button with Dropdown */
    .add-btn-container {
      position: relative;
    }

    .add-btn {
      width: 40px;
      height: 40px;
      background: #15803d;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .add-btn:hover {
      background: #166534;
      transform: scale(1.05);
    }

    .add-dropdown {
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      min-width: 200px;
      display: none;
      z-index: 1001;
    }

    .add-dropdown.show {
      display: block;
    }

    .dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 1px solid #f1f5f9;
      font-size: 14px;
      color: #0f172a;
    }

    .dropdown-item:last-child {
      border-bottom: none;
    }

    .dropdown-item:hover {
      background: #f8fafc;
    }

    .dropdown-item-icon {
      margin-right: 10px;
      font-size: 16px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: #15803d;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
      font-size: 16px;
    }

    .user-details {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .user-name {
      color: white;
      font-size: 14px;
      font-weight: 600;
    }

    .user-email {
      color: #94a3b8;
      font-size: 12px;
    }

    .logout-btn {
      padding: 8px 16px;
      background: #dc2626;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #b91c1c;
    }

    /* Main Content */
    .main-content {
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .page-header {
      margin-bottom: 30px;
    }

    .page-title {
      font-size: 32px;
      font-weight: 700;
      color: #0f172a;
      margin-bottom: 8px;
    }

    .page-subtitle {
      font-size: 14px;
      color: #64748b;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      transition: all 0.2s;
    }

    .stat-card:hover {
      border-color: #cbd5e1;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .stat-label {
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }

    .stat-value {
      font-size: 42px;
      font-weight: 800;
      color: #0f172a;
      line-height: 1;
      margin-bottom: 8px;
    }

    .stat-value.green { color: #15803d; }
    .stat-value.amber { color: #ea580c; }
    .stat-value.red { color: #dc2626; }

    .stat-footer {
      font-size: 13px;
      color: #64748b;
    }

    /* Table Section */
    .table-section {
      background: white;
      padding: 24px;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }

    .table-header {
      font-size: 18px;
      font-weight: 600;
      color: #0f172a;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid #e2e8f0;
    }

    .applications-table {
      width: 100%;
      border-collapse: collapse;
    }

    .applications-table th {
      text-align: left;
      padding: 12px;
      font-size: 12px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #e2e8f0;
    }

    .applications-table td {
      padding: 16px 12px;
      font-size: 14px;
      color: #0f172a;
      border-bottom: 1px solid #f1f5f9;
    }

    .applications-table tr:hover {
      background: #f8fafc;
    }

    /* Status Badge */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .status-pending {
      background: #f1f5f9;
      color: #64748b;
    }

    .status-approved {
      background: #f0fdf4;
      color: #15803d;
    }

    .status-rejected {
      background: #fef2f2;
      color: #dc2626;
    }

    /* Action Buttons */
    .btn-edit, .btn-delete {
      padding: 6px 14px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-right: 5px;
    }

    .btn-edit {
      background: #3b82f6;
      color: white;
    }

    .btn-edit:hover {
      background: #2563eb;
    }

    .btn-delete {
      background: #dc2626;
      color: white;
    }

    .btn-delete:hover {
      background: #b91c1c;
    }

    /* Edit Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 20px;
      color: #0f172a;
    }

    .modal-form-group {
      margin-bottom: 15px;
    }

    .modal-form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .modal-form-group input,
    .modal-form-group select,
    .modal-form-group textarea {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-family: inherit;
      font-size: 14px;
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-save {
      background: #15803d;
      color: white;
    }

    .btn-save:hover {
      background: #166534;
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
    }

    .btn-cancel:hover {
      background: #5a6268;
    }

    /* OT Application Modal */
    .ot-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 3000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .ot-modal-overlay.active {
      display: flex;
    }

    .ot-modal-content {
      background: white;
      padding: 0;
      border-radius: 16px;
      max-width: 600px;
      width: 95%;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .ot-modal-header {
      background: #1e293b;
      color: white;
      padding: 20px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .ot-modal-header h2 {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ot-modal-close {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      line-height: 1;
    }

    .ot-modal-close:hover {
      opacity: 1;
    }

    .ot-modal-body {
      padding: 24px;
      max-height: calc(90vh - 140px);
      overflow-y: auto;
    }

    .ot-info-box {
      background: #f0fdf4;
      border-left: 4px solid #15803d;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .ot-info-box p {
      color: #166534;
      font-size: 14px;
      margin: 4px 0;
    }

    .ot-info-box .remaining-hours {
      font-size: 18px;
      font-weight: 700;
    }

    .ot-block-warning {
      display: none;
      background: #fef2f2;
      border: 2px solid #dc2626;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      color: #991b1b;
    }

    .ot-block-warning strong {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }

    .ot-form-group {
      margin-bottom: 20px;
    }

    .ot-form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #0f172a;
      font-size: 14px;
    }

    .ot-form-group label .required {
      color: #dc2626;
    }

    .ot-form-group input,
    .ot-form-group select,
    .ot-form-group textarea {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .ot-form-group input:focus,
    .ot-form-group select:focus,
    .ot-form-group textarea:focus {
      outline: none;
      border-color: #15803d;
      box-shadow: 0 0 0 3px rgba(21, 128, 61, 0.1);
    }

    .ot-form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .ot-form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .ot-form-row-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    .ot-modal-footer {
      padding: 16px 24px 24px;
      display: flex;
      gap: 12px;
    }

    .ot-modal-footer button {
      flex: 1;
      padding: 14px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .ot-btn-cancel {
      background: #f1f5f9;
      color: #64748b;
    }

    .ot-btn-cancel:hover {
      background: #e2e8f0;
    }

    .ot-btn-submit {
      background: #15803d;
      color: white;
    }

    .ot-btn-submit:hover {
      background: #166534;
    }

    .ot-btn-submit:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .ot-success-message,
    .ot-error-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: none;
      font-size: 14px;
    }

    .ot-success-message {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .ot-error-message {
      background: #fef2f2;
      color: #991b1b;
      border: 1px solid #fecaca;
    }
  </style>
</head>
<body>
  <!-- Top Navigation -->
  <nav class="top-nav">
    <div class="nav-left">
      <div class="logo">
        <div class="logo-icon">OT</div>
        <span>OTMS</span>
      </div>
      <div class="nav-links">
        <a href="javascript:void(0)" class="nav-link active">Dashboard</a>
      </div>
    </div>

    <div class="nav-right">
      <!-- Add Button with Dropdown -->
      <div class="add-btn-container">
        <button class="add-btn" onclick="toggleAddMenu()">+</button>
        <div class="add-dropdown" id="addDropdown">
          <div class="dropdown-item" onclick="applyNewOT()">
            <span class="dropdown-item-icon">üìù</span>
            Apply New OT
          </div>
          <div class="dropdown-item" onclick="applyOTClaim()">
            <span class="dropdown-item-icon">üí∞</span>
            OT Claim
          </div>
          <div class="dropdown-item" onclick="applyLeave()">
            <span class="dropdown-item-icon">üèñÔ∏è</span>
            Leave Request
          </div>
        </div>
      </div>

      <div class="user-info">
        <div class="user-details">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-email" id="userEmail"></div>
        </div>
        <div class="user-avatar" id="userAvatar">S</div>
      </div>

      <button onclick="handleLogout()" class="logout-btn">Logout</button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <div class="page-header">
      <h1 class="page-title">Staff Dashboard</h1>
      <p class="page-subtitle">Overview of your overtime applications and hours</p>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total OT Hours</div>
        <div class="stat-value" id="totalOTHours">0</div>
        <div class="stat-footer">All applications</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Remaining Hours</div>
        <div class="stat-value" id="remainingHours">104</div>
        <div class="stat-footer">Out of 104h limit</div>
      </div>

      <div class="stat-card">
        <div class="stat-label">Applications</div>
        <div class="stat-value" id="totalApplications">0</div>
        <div class="stat-footer">Total submitted</div>
      </div>
    </div>

    <!-- Applications Table -->
    <div class="table-section">
      <div class="table-header">My OT Applications</div>
      <table class="applications-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Time</th>
            <th>Hours</th>
            <th>Type</th>
            <th>Remark</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="applicationsTable">
          <tr><td colspan="7" style="text-align: center; color: #94a3b8;">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal-overlay" id="editModal">
    <div class="modal-content">
      <div class="modal-header">Edit OT Application</div>
      <form id="editForm">
        <div class="modal-form-group">
          <label>Date</label>
          <input type="date" id="editDate" required>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="modal-form-group">
            <label>Start Time</label>
            <input type="time" id="editStartTime" required>
          </div>
          <div class="modal-form-group">
            <label>End Time</label>
            <input type="time" id="editEndTime" required>
          </div>
        </div>
        <div class="modal-form-group">
          <label>Total Hours</label>
          <input type="number" id="editTotalHours" step="0.5" readonly>
        </div>
        <div class="modal-form-group">
          <label>OT Type</label>
          <select id="editOTType" required>
            <option value="Operation">Operation</option>
            <option value="Project">Project</option>
          </select>
        </div>
        <div class="modal-form-group">
          <label>Is Public Holiday?</label>
          <select id="editPublicHoliday">
            <option value="No">No</option>
            <option value="Yes">Yes</option>
          </select>
        </div>
        <div class="modal-form-group">
          <label>Remark</label>
          <textarea id="editRemark" rows="3" required></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
          <button type="submit" class="btn-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- OT Application Modal -->
  <div class="ot-modal-overlay" id="otApplicationModal">
    <div class="ot-modal-content">
      <div class="ot-modal-header">
        <h2>üìù Apply for Overtime</h2>
        <button class="ot-modal-close" onclick="closeOTModal()">&times;</button>
      </div>
      <div class="ot-modal-body">
        <div id="otSuccessMessage" class="ot-success-message"></div>
        <div id="otErrorMessage" class="ot-error-message"></div>
        
        <div class="ot-info-box">
          <p><strong>Name:</strong> <span id="otUserName"></span></p>
          <p><strong>Team:</strong> <span id="otUserTeam"></span></p>
          <p><strong>Remaining OT Hours:</strong> <span id="otRemainingHours" class="remaining-hours">Loading...</span></p>
        </div>
        
        <div id="otBlockWarning" class="ot-block-warning">
          <strong>‚ö†Ô∏è OT Limit Reached!</strong>
          <p>You have reached or exceeded the 104-hour limit. New OT applications are blocked.</p>
        </div>
        
        <form id="otApplicationForm">
          <div class="ot-form-group">
            <label>OT Date <span class="required">*</span></label>
            <input type="date" id="otDate" required>
          </div>
          
          <div class="ot-form-row-3">
            <div class="ot-form-group">
              <label>Start Time <span class="required">*</span></label>
              <input type="time" id="otStartTime" required>
            </div>
            <div class="ot-form-group">
              <label>End Time <span class="required">*</span></label>
              <input type="time" id="otEndTime" required>
            </div>
            <div class="ot-form-group">
              <label>Total Hours</label>
              <input type="number" id="otTotalHours" step="0.5" min="0.5" readonly>
            </div>
          </div>
          
          <div class="ot-form-row">
            <div class="ot-form-group">
              <label>OT Type <span class="required">*</span></label>
              <select id="otType" required>
                <option value="">Select OT Type</option>
                <option value="Operation">Operation</option>
                <option value="Project">Project</option>
              </select>
            </div>
            <div class="ot-form-group">
              <label>Public Holiday?</label>
              <select id="otPublicHoliday">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
          </div>
          
          <div class="ot-form-group">
            <label>Remark <span class="required">*</span></label>
            <textarea id="otReason" placeholder="Please provide details about the overtime work..." required></textarea>
          </div>
        </form>
      </div>
      <div class="ot-modal-footer">
        <button type="button" class="ot-btn-cancel" onclick="closeOTModal()">Cancel</button>
        <button type="button" class="ot-btn-submit" id="otSubmitBtn" onclick="submitOTApplication()">Submit Application</button>
      </div>
    </div>
  </div>

  <script>
    const webAppUrl = '<?= webAppUrl ?>';
    const sessionId = '<?= sessionId ?>';
    const userEmail = '<?= userEmail ?>';
    const userName = '<?= userName ?>';
    const userTeam = '<?= userTeam ?>';

    // Validate session data exists
    if (!userEmail || !userName || userEmail === 'undefined' || userName === 'undefined') {
      alert('Session expired. Please login again.');
      window.top.location.href = webAppUrl + '?page=login';
      throw new Error('Invalid session');
    }

    document.getElementById('userName').textContent = userName;
    document.getElementById('userEmail').textContent = userEmail;
    document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();

    let allApplications = [];
    let editingIndex = null;

    // Toggle add menu dropdown
    function toggleAddMenu() {
      const dropdown = document.getElementById('addDropdown');
      dropdown.classList.toggle('show');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const addContainer = document.querySelector('.add-btn-container');
      if (!addContainer.contains(event.target)) {
        document.getElementById('addDropdown').classList.remove('show');
      }
    });

    // Auto-calculate hours when time changes in edit modal
    document.getElementById('editStartTime').addEventListener('change', calculateEditHours);
    document.getElementById('editEndTime').addEventListener('change', calculateEditHours);

    function calculateEditHours() {
      const startTime = document.getElementById('editStartTime').value;
      const endTime = document.getElementById('editEndTime').value;

      if (startTime && endTime) {
        const start = new Date('2000-01-01 ' + startTime);
        const end = new Date('2000-01-01 ' + endTime);
        let diff = (end - start) / (1000 * 60 * 60);
        if (diff < 0) diff += 24;
        document.getElementById('editTotalHours').value = diff.toFixed(1);
      }
    }

    function openEditModal(index) {
      const app = allApplications[index];
      editingIndex = index;

      // Populate form
      document.getElementById('editDate').value = app.Date;
      document.getElementById('editStartTime').value = app.StartTime;
      document.getElementById('editEndTime').value = app.EndTime;
      document.getElementById('editTotalHours').value = app.TotalHours;
      document.getElementById('editOTType').value = app.OT_Type;
      document.getElementById('editPublicHoliday').value = app.Is_Public_Holiday;
      document.getElementById('editRemark').value = app.Reason;

      // Show modal
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
      document.getElementById('editForm').reset();
      editingIndex = null;
    }

    // Handle edit form submission
    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();

      if (editingIndex === null) return;

      const app = allApplications[editingIndex];
      const formData = {
        rowNumber: app.rowNumber,
        date: document.getElementById('editDate').value,
        startTime: document.getElementById('editStartTime').value,
        endTime: document.getElementById('editEndTime').value,
        totalHours: document.getElementById('editTotalHours').value,
        otType: document.getElementById('editOTType').value,
        isPublicHoliday: document.getElementById('editPublicHoliday').value,
        reason: document.getElementById('editRemark').value
      };

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            alert('‚úì Application updated successfully!');
            closeEditModal();
            loadDashboard();
          } else {
            alert('Error: ' + result.message);
          }
        })
        .withFailureHandler(function(error) {
          alert('Error: ' + error.message);
        })
        .editOTApplication(formData);
    });

    function deleteApplication(index) {
      const app = allApplications[index];

      if (confirm('Are you sure you want to delete this OT application?')) {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              alert('‚úì Application deleted successfully!');
              loadDashboard();
            } else {
              alert('Error: ' + result.message);
            }
          })
          .withFailureHandler(function(error) {
            alert('Error: ' + error.message);
          })
          .deleteOTApplication(app.rowNumber);
      }
    }

    function applyOTClaim() {
      document.getElementById('addDropdown').classList.remove('show');
      window.top.location.href = webAppUrl + '?page=ot-claim&sessionId=' + encodeURIComponent(sessionId);
    }

    function applyLeave() {
      document.getElementById('addDropdown').classList.remove('show');
      window.top.location.href = webAppUrl + '?page=leave-application&sessionId=' + encodeURIComponent(sessionId);
    }

    function loadDashboard() {
      console.log('=== LOADING DASHBOARD ===');
      console.log('User:', userName, 'Email:', userEmail);

      try {
        google.script.run
          .withSuccessHandler(function(data) {
            try {
              console.log('‚úÖ Dashboard data received:', data);

              if (!data) {
                console.error('ERROR: Data is null or undefined');
                return;
              }

              const totalHours = data.totalOTHours || 0;
              const remaining = data.remainingHours || 104;
              const apps = data.applications || [];

              console.log('Total Applications:', apps.length);
              console.log('Total OT Hours:', totalHours);
              console.log('Remaining Hours:', remaining);
              console.log('Color:', data.remainingColor);

              // Store all applications globally
              allApplications = apps;

              // Update DOM
              const totalEl = document.getElementById('totalOTHours');
              if (totalEl) totalEl.textContent = totalHours.toFixed(1);

              // Update Remaining Hours card
              const remainingEl = document.getElementById('remainingHours');
              if (remainingEl) {
                remainingEl.textContent = remaining.toFixed(1);
                remainingEl.className = 'stat-value';
                if (data.remainingColor === 'green') remainingEl.classList.add('green');
                else if (data.remainingColor === 'amber') remainingEl.classList.add('amber');
                else if (data.remainingColor === 'red') remainingEl.classList.add('red');
              }

              const appCountEl = document.getElementById('totalApplications');
              if (appCountEl) appCountEl.textContent = apps.length;

              displayApplications(apps);
            } catch (err) {
              console.error('Error in success handler:', err);
              console.error('Stack:', err.stack);
            }
          })
          .withFailureHandler(function(error) {
            console.error('‚ùå Dashboard load FAILED:', error);
            console.error('Error message:', error.message);
            console.error('Error stack:', error.stack);
          })
          .getStaffDashboard(userEmail);
      } catch (err) {
        console.error('ERROR calling getStaffDashboard:', err);
      }
    }

    function displayApplications(applications) {
      const tbody = document.getElementById('applicationsTable');

      if (applications.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #94a3b8;">No applications yet</td></tr>';
        return;
      }

      tbody.innerHTML = applications.map((app, index) => {
        const statusClass = 'status-' + (app.Status || 'pending').toLowerCase();
        return `
          <tr>
            <td>${formatDate(app.Date)}</td>
            <td>${formatTime(app.StartTime)} - ${formatTime(app.EndTime)}</td>
            <td>${parseFloat(app.TotalHours || 0).toFixed(1)}h</td>
            <td>${app.OT_Type || 'N/A'}</td>
            <td>${app.Reason || '-'}</td>
            <td><span class="status-badge ${statusClass}">${app.Status || 'Pending'}</span></td>
            <td>
              <button class="btn-edit" onclick="openEditModal(${index})">Edit</button>
              <button class="btn-delete" onclick="deleteApplication(${index})">Delete</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function applyNewOT() {
      document.getElementById('addDropdown').classList.remove('show');
      openOTModal();
    }

    // ========== OT APPLICATION MODAL FUNCTIONS ==========
    let userRemainingHours = 104;

    function openOTModal() {
      // Populate user info
      document.getElementById('otUserName').textContent = userName;
      document.getElementById('otUserTeam').textContent = userTeam;
      
      // Set default date to today
      document.getElementById('otDate').valueAsDate = new Date();
      
      // Reset form
      document.getElementById('otApplicationForm').reset();
      document.getElementById('otDate').valueAsDate = new Date();
      hideOTMessages();
      
      // Update remaining hours display
      const remainingDisplay = document.getElementById('otRemainingHours');
      const remainingEl = document.getElementById('remainingHours');
      const currentRemaining = parseFloat(remainingEl.textContent) || 104;
      userRemainingHours = currentRemaining;
      
      remainingDisplay.textContent = currentRemaining.toFixed(1) + 'h / 104h';
      
      // Check if blocked
      const submitBtn = document.getElementById('otSubmitBtn');
      const blockWarning = document.getElementById('otBlockWarning');
      
      if (currentRemaining <= 0) {
        remainingDisplay.style.color = '#dc2626';
        blockWarning.style.display = 'block';
        submitBtn.disabled = true;
        submitBtn.textContent = 'OT Limit Reached';
      } else if (currentRemaining <= 14) {
        remainingDisplay.style.color = '#ea580c';
        blockWarning.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
      } else {
        remainingDisplay.style.color = '#15803d';
        blockWarning.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
      }
      
      // Show modal
      document.getElementById('otApplicationModal').classList.add('active');
    }

    function closeOTModal() {
      document.getElementById('otApplicationModal').classList.remove('active');
      document.getElementById('otApplicationForm').reset();
      hideOTMessages();
    }

    function hideOTMessages() {
      document.getElementById('otSuccessMessage').style.display = 'none';
      document.getElementById('otErrorMessage').style.display = 'none';
    }

    function showOTError(message) {
      const el = document.getElementById('otErrorMessage');
      el.textContent = message;
      el.style.display = 'block';
      document.getElementById('otSuccessMessage').style.display = 'none';
    }

    function showOTSuccess(message) {
      const el = document.getElementById('otSuccessMessage');
      el.textContent = message;
      el.style.display = 'block';
      document.getElementById('otErrorMessage').style.display = 'none';
    }

    // Auto-calculate OT hours
    document.getElementById('otStartTime').addEventListener('change', calculateOTHours);
    document.getElementById('otEndTime').addEventListener('change', calculateOTHours);
    document.getElementById('otStartTime').addEventListener('input', calculateOTHours);
    document.getElementById('otEndTime').addEventListener('input', calculateOTHours);

    function calculateOTHours() {
      const startTime = document.getElementById('otStartTime').value;
      const endTime = document.getElementById('otEndTime').value;
      
      if (startTime && endTime) {
        const start = new Date('2000-01-01 ' + startTime);
        const end = new Date('2000-01-01 ' + endTime);
        
        if (end < start) {
          end.setDate(end.getDate() + 1); // Handle overnight OT
        }
        
        const diffMs = end - start;
        const hours = diffMs / (1000 * 60 * 60);
        document.getElementById('otTotalHours').value = hours.toFixed(2);
      }
    }

    function submitOTApplication() {
      hideOTMessages();
      
      const formData = {
        name: userName,
        team: userTeam,
        date: document.getElementById('otDate').value,
        startTime: document.getElementById('otStartTime').value,
        endTime: document.getElementById('otEndTime').value,
        totalHours: parseFloat(document.getElementById('otTotalHours').value),
        otType: document.getElementById('otType').value,
        isPublicHoliday: document.getElementById('otPublicHoliday').value,
        proofAttendance: '',
        reason: document.getElementById('otReason').value,
        status: 'Pending',
        approvedBy: '',
        approvalDate: ''
      };
      
      // Validate
      if (!formData.date || !formData.startTime || !formData.endTime) {
        showOTError('Please fill in all required fields');
        return;
      }
      
      if (!formData.otType) {
        showOTError('Please select an OT Type');
        return;
      }
      
      if (!formData.reason) {
        showOTError('Please provide a remark');
        return;
      }
      
      if (formData.totalHours <= 0 || isNaN(formData.totalHours)) {
        showOTError('Total hours must be greater than 0');
        return;
      }
      
      // Check if exceeds remaining hours
      if (formData.totalHours > userRemainingHours) {
        showOTError('Cannot apply! Requested ' + formData.totalHours + 'h exceeds your remaining ' + userRemainingHours.toFixed(1) + 'h.');
        return;
      }
      
      // Disable submit button
      const submitBtn = document.getElementById('otSubmitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showOTSuccess('OT Application submitted successfully!');
            
            // Close modal after short delay and refresh dashboard
            setTimeout(function() {
              closeOTModal();
              loadDashboard();
            }, 1500);
          } else {
            let errorMsg = result.message || 'Failed to submit application';
            if (result.remainingHours !== undefined) {
              errorMsg += ' (Remaining: ' + result.remainingHours.toFixed(1) + 'h)';
            }
            showOTError(errorMsg);
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Application';
          }
        })
        .withFailureHandler(function(error) {
          showOTError('Error: ' + error.message);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit Application';
        })
        .submitOTApplication(formData);
    }

    // Close modal when clicking outside
    document.getElementById('otApplicationModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeOTModal();
      }
    });

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';

      // If it's a Date object, format it
      if (dateStr instanceof Date) {
        return dateStr.toLocaleDateString('en-CA');
      }

      // If it's a string that looks like a date object's toString() output
      if (typeof dateStr === 'string' && dateStr.includes('GMT')) {
        try {
          const date = new Date(dateStr);
          return date.toLocaleDateString('en-CA');
        } catch (e) {
          return dateStr;
        }
      }

      // If it's ISO format with 'T'
      if (dateStr.toString().includes('T')) {
        return dateStr.toString().split('T')[0];
      }

      // Otherwise return as-is
      return dateStr.toString();
    }

    function formatTime(timeStr) {
      if (!timeStr) return '';

      // If it's already in HH:mm format, return as-is
      if (typeof timeStr === 'string' && /^\d{1,2}:\d{2}(:\d{2})?$/.test(timeStr)) {
        // Remove seconds if present (HH:mm:ss -> HH:mm)
        return timeStr.split(':').slice(0, 2).join(':');
      }

      // If it's a Date object or date string
      if (timeStr instanceof Date) {
        const hours = timeStr.getHours().toString().padStart(2, '0');
        const mins = timeStr.getMinutes().toString().padStart(2, '0');
        return hours + ':' + mins;
      }

      // If it's a string that looks like a date
      if (typeof timeStr === 'string' && (timeStr.includes('GMT') || timeStr.includes('T'))) {
        try {
          const date = new Date(timeStr);
          const hours = date.getHours().toString().padStart(2, '0');
          const mins = date.getMinutes().toString().padStart(2, '0');
          return hours + ':' + mins;
        } catch (e) {
          return timeStr;
        }
      }

      return timeStr.toString();
    }

    function handleLogout() {
      if (confirm('Logout?')) {
        google.script.run
          .withSuccessHandler(function() {
            window.top.location.href = webAppUrl + '?page=login';
          })
          .withFailureHandler(function() {
            window.top.location.href = webAppUrl + '?page=login';
          })
          .logout(sessionId);
      }
    }

    loadDashboard();
  </script>
</body>
</html>
